<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="signInTitle">Sign In</title>

  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>

  <!-- Load sanitiser -->
  <script src="js/sanitise.js"></script>

  <link rel="stylesheet" href="./css/Sign-In.css" />
  <link rel="icon" type="image/png" href="images/Logo.png">
</head>

<body>
  <section class="card">
    <h1 data-i18n="signIn">Sign In</h1>

    <div class="message-wrap">
      <p id="msgInfo" class="message show" data-i18n="msgInfo">Fill the details to continue</p>
      <p id="msgError" class="message" data-i18n="msgError">Please enter a valid email address.</p>
    </div>

    <form id="loginForm" novalidate>
      <div class="field-group">
        <label for="email" data-i18n="emailLabel">Email</label>
        <div class="field">
          <input id="email" name="email" type="email" required />
        </div>
      </div>

      <div class="field-group">
        <label for="password" data-i18n="passwordLabel">Password</label>
        <div class="field">
          <input id="password" type="password" required />
          <button type="button" class="toggle-btn" id="togglePw">
            <span id="eyeIcon">
              <span class="iconify" data-icon="mdi:eye-outline" data-width="24" data-height="24"></span>
            </span>
          </button>
        </div>
      </div>

      <div class="forgot-wrap">
        <a class="forgot" href="ForgotPassword.html" data-i18n="forgot">Forgot Password?</a>
      </div>

      <button type="submit" id="submitBtn" class="submit" disabled data-i18n="signInBtn">Sign In</button>
    </form>
  </section>

  <script>
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    const submitBtn = document.getElementById('submitBtn');
    const eyeIcon = document.getElementById('eyeIcon');
    const msgInfo = document.getElementById('msgInfo');
    const msgError = document.getElementById('msgError');

    function updateButtonState() {
      const emailValid = emailEl.checkValidity();
      const pwValid = pwEl.value.trim() !== '';
      const ok = emailValid && pwValid;

      submitBtn.disabled = !ok;
      submitBtn.classList.toggle('enabled', ok);

      if (emailEl.value && !emailValid) {
        msgInfo.classList.remove('show');
        msgError.classList.add('show');
      } else {
        msgError.classList.remove('show');
        msgInfo.classList.add('show');
      }
    }

    emailEl.addEventListener('input', updateButtonState);
    pwEl.addEventListener('input', updateButtonState);

    document.getElementById('togglePw').addEventListener('click', () => {
      const showing = pwEl.type === 'text';
      pwEl.type = showing ? 'password' : 'text';
      eyeIcon.innerHTML = showing
        ? '<span class="iconify" data-icon="mdi:eye-outline" data-width="24" data-height="24"></span>'
        : '<span class="iconify" data-icon="mdi:eye-off-outline" data-width="24" data-height="24"></span>';
    });
  </script>

  <!-- Firebase Login with lockout protection -->
  <script type="module">
    import { auth, db } from "./js/firebase-init.js";
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // üîê Lockout state (similar idea to Flutter app)
    let isLocked = false;
    let lockEndTime = null;
    const LOCK_STORAGE_KEY = "adminLoginLock";
    let lockInterval = null;

    function loadLockState() {
      const raw = localStorage.getItem(LOCK_STORAGE_KEY);
      if (!raw) return;

      try {
        const data = JSON.parse(raw);
        if (data.lockEndTime && data.lockEndTime > Date.now()) {
          isLocked = true;
          lockEndTime = data.lockEndTime;
          showLockMessage();
          startLockCountdown();
        } else {
          // lock expired
          localStorage.removeItem(LOCK_STORAGE_KEY);
        }
      } catch (e) {
        console.error("Failed to parse lock state", e);
        localStorage.removeItem(LOCK_STORAGE_KEY);
      }
    }

    function saveLockState() {
      if (!lockEndTime) return;
      localStorage.setItem(
        LOCK_STORAGE_KEY,
        JSON.stringify({ lockEndTime })
      );
    }

    function clearLockState() {
      isLocked = false;
      lockEndTime = null;
      localStorage.removeItem(LOCK_STORAGE_KEY);
      if (lockInterval) clearInterval(lockInterval);
      msgError.classList.remove("show");
      msgInfo.classList.add("show");
    }

    function startLockCountdown() {
      if (lockInterval) clearInterval(lockInterval);

      lockInterval = setInterval(() => {
        if (!isLocked || !lockEndTime) {
          clearInterval(lockInterval);
          return;
        }

        const remainingMs = lockEndTime - Date.now();
        if (remainingMs <= 0) {
          clearInterval(lockInterval);
          clearLockState();
          return;
        }
        showLockMessage();
      }, 1000);
    }

    function showLockMessage() {
      if (!lockEndTime) return;

      const remainingSec = Math.max(
        0,
        Math.floor((lockEndTime - Date.now()) / 1000)
      );

      msgInfo.classList.remove("show");
      msgError.classList.add("show");

      // Optional: if you have a dynamic translation like login_locked in lang.js
      if (typeof window.currentTranslations !== "undefined" &&
          typeof window.currentTranslations.login_locked === "function") {
        msgError.textContent = window.currentTranslations.login_locked(remainingSec);
      } else {
        const mins = Math.ceil(remainingSec / 60);
        msgError.textContent =
          `Too many attempts. Please try again in ${mins} minute(s).`;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      // Load lock state from previous attempts
      loadLockState();

      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // üö´ If locked, block immediately
        if (isLocked) {
          showLockMessage();
          return;
        }

        const rawEmail = document.getElementById("email").value;
        const rawPassword = document.getElementById("password").value;

        // üîí Sanitize inputs
        const result = window.sanitiseTextInput(rawEmail, 100);
        if (!result.ok) {
          msgInfo.classList.remove("show");
          msgError.textContent =
            (window.currentTranslations && window.currentTranslations.msgError) ||
            result.error;
          msgError.classList.add("show");
          return;
        }

        const email = result.value.toLowerCase();
        const password = rawPassword.trim(); // password isn't rendered ‚Äî safe

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          const privateDocRef = doc(db, "users", user.uid, "private", "data");
          const privateDocSnap = await getDoc(privateDocRef);

          if (privateDocSnap.exists()) {
            const role = privateDocSnap.data().role || "user";

            if (role === "admin") {
              msgError.classList.remove("show");
              msgInfo.classList.add("show");
              // ‚úÖ Successful login ‚Üí clear any existing lock
              clearLockState();
              window.location.href = "Home.html";
            } else {
              msgInfo.classList.remove("show");
              msgError.classList.add("show");
              msgError.textContent =
                (window.currentTranslations && window.currentTranslations.adminDenied) ||
                "Access denied. Admins only.";
            }
          } else {
            msgInfo.classList.remove("show");
            msgError.classList.add("show");
            msgError.textContent = "User data not found.";
          }
        } catch (error) {
          console.error("Login failed:", error);
          msgInfo.classList.remove("show");
          msgError.classList.add("show");

          // ‚ö†Ô∏è Same idea as app: brute force / too many attempts ‚Üí lock for 3 minutes
          if (error.code === "auth/too-many-requests") {
            const threeMinutesMs = 3 * 60 * 1000;
            isLocked = true;
            lockEndTime = Date.now() + threeMinutesMs;
            saveLockState();
            startLockCountdown();
            showLockMessage();
          } else {
            // Other errors ‚Üí generic message from translations
            msgError.textContent =
              (window.currentTranslations && window.currentTranslations.msgError2) ||
              "Login failed. Please check your credentials and try again.";
          }
        }
      });
    });
  </script>

  <script src="./js/lang.js"></script>
</body>

</html>
