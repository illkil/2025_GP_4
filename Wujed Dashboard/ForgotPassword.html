<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title data-i18n="forgotTitle">Forgot Password</title>
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
<link rel="stylesheet" href="./css/Verification.css" />
<link rel="icon" type="image/png" href="images/Logo.png">
</head>
<body>

  <section class="card" role="dialog" aria-labelledby="title">
    <div class="top">
      <a href="Sign-In.html" class="back" aria-label="Back">
        <span class="iconify" data-icon="mdi:chevron-left" data-width="22" data-height="22"></span>
      </a>
      <h1 id="title" data-i18n="forgotPasswordTitle">Forgot Password</h1>
      <span class="spacer" aria-hidden="true"></span>
    </div>

    <div class="message-wrap">
      <p id="msgInfo" class="message show" data-i18n="msgForgotInfo">
        Enter your email account to reset your password
      </p>
      <p id="msgError" class="message" data-i18n="msgForgotError">
        Please enter a valid email address.
      </p>
    </div>

    <form id="forgotForm" novalidate>
      <!-- Email -->
      <div class="field-group">
        <label for="email" data-i18n="emailLabel">Email</label>
        <div class="field">
          <input id="email" name="email" type="email" required />
        </div>
      </div>

      <button type="submit" id="submitBtn" class="submit" disabled data-i18n="continueBtn">Continue</button>
    </form>
  </section>

<!-- load EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){
  //public key
  emailjs.init("UtmASjdZ_iMNSqjx8");
})();
</script>

<!-- Forgot Password script -->
<script type="module">
import { auth, db } from "./js/firebase-init.js";
import {
  fetchSignInMethodsForEmail
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const form = document.getElementById("forgotForm");
const emailInput = document.getElementById("email");
const msgInfo = document.getElementById("msgInfo");
const msgError = document.getElementById("msgError");
const submitBtn = document.getElementById("submitBtn");

emailInput.addEventListener("input", () => {
  const valid = emailInput.checkValidity();
  submitBtn.disabled = !valid;
  submitBtn.classList.toggle("enabled", valid);
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = emailInput.value.trim().toLowerCase();

  function clearMessages() {
    msgInfo.classList.remove("show");
    msgError.classList.remove("show");
  }

  try {
    clearMessages();
    msgInfo.textContent = currentTranslations.loadingMsg;
    msgInfo.classList.add("show");

    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", email), where("role", "==", "admin"));
    const querySnap = await getDocs(q);

    if (querySnap.empty) {
      clearMessages();
      msgError.textContent = currentTranslations.adminDenied;
      msgError.classList.add("show");
      return;
    }

    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    sessionStorage.setItem("otp", otp);
    sessionStorage.setItem("verifiedEmail", email);

    const templateParams = {
      email: email,
      passcode: otp,
      time: new Date().toLocaleTimeString()
    };

    await emailjs.send("service_at80fle", "template_mtqawuj", templateParams);

    msgInfo.textContent = currentTranslations.msgVerificationSent;
    setTimeout(() => {
      window.location.href = "Verification.html";
    }, 1500);

  } catch (err) {
    console.error(err);
    clearMessages();
    msgError.textContent = currentTranslations.msgResetPasswordError;
    msgError.classList.add("show");
  }
});

</script>



<script src="./js/lang.js"></script>
</body>
</html>
